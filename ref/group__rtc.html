<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libdragon: Real-Time Clock Subsystem</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libdragon
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a> &#124;
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">Real-Time Clock Subsystem<div class="ingroups"><a class="el" href="group__libdragon.html">libdragon</a> &raquo; <a class="el" href="group__peripherals.html">Peripherals subsystem</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>Real-time clock interface.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:rtc_8c"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtc_8c.html">rtc.c</a></td></tr>
<tr class="memdesc:rtc_8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Real-Time Clock Subsystem. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:rtc_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtc_8h.html">rtc.h</a></td></tr>
<tr class="memdesc:rtc_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Real-Time Clock Subsystem. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:structrtc__time__t"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#structrtc__time__t">rtc_time_t</a></td></tr>
<tr class="memdesc:structrtc__time__t"><td class="mdescLeft">&#160;</td><td class="mdescRight">Structure for storing RTC time data.  <a href="group__rtc.html#structrtc__time__t">More...</a><br /></td></tr>
<tr class="separator:structrtc__time__t"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ga0dc5d7e2affd2f2156180e815dd14ad4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#ga0dc5d7e2affd2f2156180e815dd14ad4">JOYBUS_RTC_IDENTIFIER</a>&#160;&#160;&#160;0x1000</td></tr>
<tr class="memdesc:ga0dc5d7e2affd2f2156180e815dd14ad4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Joybus real-time clock identifier.  <a href="group__rtc.html#ga0dc5d7e2affd2f2156180e815dd14ad4">More...</a><br /></td></tr>
<tr class="separator:ga0dc5d7e2affd2f2156180e815dd14ad4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga57d6e9d3af5cf6bd9fc9583b402f4057"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#ga57d6e9d3af5cf6bd9fc9583b402f4057">JOYBUS_RTC_WRITE_BLOCK_DELAY</a>&#160;&#160;&#160;20</td></tr>
<tr class="memdesc:ga57d6e9d3af5cf6bd9fc9583b402f4057"><td class="mdescLeft">&#160;</td><td class="mdescRight">Duration (in milliseconds) to wait after writing a Joybus RTC block.  <a href="group__rtc.html#ga57d6e9d3af5cf6bd9fc9583b402f4057">More...</a><br /></td></tr>
<tr class="separator:ga57d6e9d3af5cf6bd9fc9583b402f4057"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0ea4d0bdff8d7f711477fb119aab0b6b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#ga0ea4d0bdff8d7f711477fb119aab0b6b">JOYBUS_RTC_WRITE_FINISHED_DELAY</a>&#160;&#160;&#160;500</td></tr>
<tr class="memdesc:ga0ea4d0bdff8d7f711477fb119aab0b6b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Duration (in milliseconds) to wait after setting Joybus RTC time.  <a href="group__rtc.html#ga0ea4d0bdff8d7f711477fb119aab0b6b">More...</a><br /></td></tr>
<tr class="separator:ga0ea4d0bdff8d7f711477fb119aab0b6b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga71dbc88287ffa0ab478324f96781d52b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#ga71dbc88287ffa0ab478324f96781d52b">JOYBUS_RTC_STATUS_RUNNING</a>&#160;&#160;&#160;0x00</td></tr>
<tr class="memdesc:ga71dbc88287ffa0ab478324f96781d52b"><td class="mdescLeft">&#160;</td><td class="mdescRight">The Joybus RTC is running.  <a href="group__rtc.html#ga71dbc88287ffa0ab478324f96781d52b">More...</a><br /></td></tr>
<tr class="separator:ga71dbc88287ffa0ab478324f96781d52b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa78b824bcfec61517abb64c6aebd995b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#gaa78b824bcfec61517abb64c6aebd995b">JOYBUS_RTC_STATUS_STOPPED</a>&#160;&#160;&#160;0x80</td></tr>
<tr class="memdesc:gaa78b824bcfec61517abb64c6aebd995b"><td class="mdescLeft">&#160;</td><td class="mdescRight">The Joybus RTC is stopped.  <a href="group__rtc.html#gaa78b824bcfec61517abb64c6aebd995b">More...</a><br /></td></tr>
<tr class="separator:gaa78b824bcfec61517abb64c6aebd995b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0879c2dcd0a902265cccaa8f9a617800"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#ga0879c2dcd0a902265cccaa8f9a617800">JOYBUS_RTC_CONTROL_MODE_SET</a>&#160;&#160;&#160;0x0004</td></tr>
<tr class="memdesc:ga0879c2dcd0a902265cccaa8f9a617800"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control mode for setting the Joybus RTC date/time.  <a href="group__rtc.html#ga0879c2dcd0a902265cccaa8f9a617800">More...</a><br /></td></tr>
<tr class="separator:ga0879c2dcd0a902265cccaa8f9a617800"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad02da8fec42199c4c2d3ae5ab18e4395"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#gad02da8fec42199c4c2d3ae5ab18e4395">JOYBUS_RTC_CONTROL_MODE_RUN</a>&#160;&#160;&#160;0x0300</td></tr>
<tr class="memdesc:gad02da8fec42199c4c2d3ae5ab18e4395"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control mode for normal operation of the Joybus RTC.  <a href="group__rtc.html#gad02da8fec42199c4c2d3ae5ab18e4395">More...</a><br /></td></tr>
<tr class="separator:gad02da8fec42199c4c2d3ae5ab18e4395"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga52141232434243f8a5442db59d3f4d17"><td class="memItemLeft" align="right" valign="top"><a id="ga52141232434243f8a5442db59d3f4d17" name="ga52141232434243f8a5442db59d3f4d17"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>RTC_GET_CACHE_INVALIDATE_TICKS</b>&#160;&#160;&#160;(<a class="el" href="group__n64sys.html#ga3dd7b7d41c220904632461a2d95d61cf">TICKS_PER_SECOND</a>)</td></tr>
<tr class="memdesc:ga52141232434243f8a5442db59d3f4d17"><td class="mdescLeft">&#160;</td><td class="mdescRight">Invalidate the most-recent RTC time cache after 1 second. <br /></td></tr>
<tr class="separator:ga52141232434243f8a5442db59d3f4d17"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="enum-members" name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:gaf4e6e809a36c78b63cd09260d3a5f561"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#gaf4e6e809a36c78b63cd09260d3a5f561">rtc_type_t</a> { <a class="el" href="group__rtc.html#ggaf4e6e809a36c78b63cd09260d3a5f561a9dab1cbcc7fe4e58711118114d5d01b9">RTC_NONE</a> = 0
, <a class="el" href="group__rtc.html#ggaf4e6e809a36c78b63cd09260d3a5f561a4d0e29dc302cd773d136d59377e7ce98">RTC_JOYBUS</a> = 1
, <a class="el" href="group__rtc.html#ggaf4e6e809a36c78b63cd09260d3a5f561a6480131f6a48328e0aa3462411b23ee6">RTC_DD</a> = 2
, <a class="el" href="group__rtc.html#ggaf4e6e809a36c78b63cd09260d3a5f561a138cd0ae48518dc61b3ee47015709791">RTC_UNKNOWN</a> = -1
 }</td></tr>
<tr class="memdesc:gaf4e6e809a36c78b63cd09260d3a5f561"><td class="mdescLeft">&#160;</td><td class="mdescRight">Real-time clock detection values.  <a href="group__rtc.html#gaf4e6e809a36c78b63cd09260d3a5f561">More...</a><br /></td></tr>
<tr class="separator:gaf4e6e809a36c78b63cd09260d3a5f561"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga7d2152c20235fcc3520e5b1931e86405"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#ga7d2152c20235fcc3520e5b1931e86405">rtc_init</a> (void)</td></tr>
<tr class="memdesc:ga7d2152c20235fcc3520e5b1931e86405"><td class="mdescLeft">&#160;</td><td class="mdescRight">High-level convenience helper to initialize the RTC subsystem.  <a href="group__rtc.html#ga7d2152c20235fcc3520e5b1931e86405">More...</a><br /></td></tr>
<tr class="separator:ga7d2152c20235fcc3520e5b1931e86405"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae6a9800f8788fe1d2232b36724e037aa"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#gae6a9800f8788fe1d2232b36724e037aa">rtc_close</a> (void)</td></tr>
<tr class="memdesc:gae6a9800f8788fe1d2232b36724e037aa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Close the RTC Subsystem, disabling system hooks.  <a href="group__rtc.html#gae6a9800f8788fe1d2232b36724e037aa">More...</a><br /></td></tr>
<tr class="separator:gae6a9800f8788fe1d2232b36724e037aa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaac762f5c809e7e955b157446071dbaf3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#gaac762f5c809e7e955b157446071dbaf3">rtc_normalize_time</a> (<a class="el" href="group__rtc.html#structrtc__time__t">rtc_time_t</a> *rtc_time)</td></tr>
<tr class="memdesc:gaac762f5c809e7e955b157446071dbaf3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate sane values for arbitrary time inputs.  <a href="group__rtc.html#gaac762f5c809e7e955b157446071dbaf3">More...</a><br /></td></tr>
<tr class="separator:gaac762f5c809e7e955b157446071dbaf3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf9cee899189bcaef3244ed0643ee181a"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#gaf9cee899189bcaef3244ed0643ee181a">rtc_get</a> (<a class="el" href="group__rtc.html#structrtc__time__t">rtc_time_t</a> *rtc_time)</td></tr>
<tr class="memdesc:gaf9cee899189bcaef3244ed0643ee181a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read the current date/time from the real-time clock.  <a href="group__rtc.html#gaf9cee899189bcaef3244ed0643ee181a">More...</a><br /></td></tr>
<tr class="separator:gaf9cee899189bcaef3244ed0643ee181a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga49e1f7e05969bedd4b4e4789861c2944"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#ga49e1f7e05969bedd4b4e4789861c2944">rtc_set</a> (<a class="el" href="group__rtc.html#structrtc__time__t">rtc_time_t</a> *write_time)</td></tr>
<tr class="memdesc:ga49e1f7e05969bedd4b4e4789861c2944"><td class="mdescLeft">&#160;</td><td class="mdescRight">High-level convenience helper to set the RTC date/time.  <a href="group__rtc.html#ga49e1f7e05969bedd4b4e4789861c2944">More...</a><br /></td></tr>
<tr class="separator:ga49e1f7e05969bedd4b4e4789861c2944"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae5c739084610784801c6689fa99f0bd4"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__rtc.html#gae5c739084610784801c6689fa99f0bd4">rtc_is_writable</a> (void)</td></tr>
<tr class="memdesc:gae5c739084610784801c6689fa99f0bd4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Determine whether the RTC supports writing the time.  <a href="group__rtc.html#gae5c739084610784801c6689fa99f0bd4">More...</a><br /></td></tr>
<tr class="separator:gae5c739084610784801c6689fa99f0bd4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p >Real-time clock interface. </p>
<dl class="section author"><dt>Author</dt><dd>Christopher Bonhage</dd></dl>
<p>The Joybus real-time clock is a cartridge peripheral that uses a battery to power a clock that tracks the date, time, and day of the week. The real-time clock keeps running even when the N64 is powered-off. The Joybus RTC is accessed through the serial interface (SI) similar to EEPROM and controllers. The Joybus RTC was only ever available on one official cartridge that was only available in Japan: D≈çbutsu no Mori (Animal Forest). Many emulators and flash carts include support for the Animal Forest RTC, which makes it possible to include real-time clock functionality in homebrew! There is also a real-time clock included in the N64DD hardware, which uses a different interface and is not currently supported by libdragon.</p>
<p >To check if the real-time clock is available, call <a class="el" href="group__rtc.html#ga7d2152c20235fcc3520e5b1931e86405" title="High-level convenience helper to initialize the RTC subsystem.">rtc_init</a>. To read the current time from the real-time clock, call <a class="el" href="group__rtc.html#gaf9cee899189bcaef3244ed0643ee181a" title="Read the current date/time from the real-time clock.">rtc_get</a>. Once the RTC subsystem is initialized, you can also use ISO C Time functions to get the current time, for example: <code>time(NULL)</code> will return the number of seconds elapsed since the UNIX epoch (January 1, 1970 at 00:00:00). To check if the real-time clock supports writes, call <a class="el" href="group__rtc.html#gae5c739084610784801c6689fa99f0bd4" title="Determine whether the RTC supports writing the time.">rtc_is_writable</a>. To write a new time to the real-time clock, call <a class="el" href="group__rtc.html#ga49e1f7e05969bedd4b4e4789861c2944" title="High-level convenience helper to set the RTC date/time.">rtc_set</a>.</p>
<p >This subsystem handles decoding and encoding the date/time from its internal format into a struct called <a class="el" href="group__rtc.html#structrtc__time__t" title="Structure for storing RTC time data.">rtc_time_t</a>, which contains integer values for year, month, day-of-month, day-of-week, hour, minute, and second.</p>
<p >The Joybus RTC contains 3 "blocks" (or zones) which contain 8 bytes of data: Block 0 contains a half-word control register and opaque calibration data. Block 1 is unused and unsupported. See notes below. Block 2 contains the current date/time as packed binary-coded decimal.</p>
<p >Animal Forest did not use block 1 at all, so most emulators do not bother to implement it. Theoretically, block 1 could be used as 8-bytes of SRAM-backed storage, but this is not supported by libdragon's Real-Time Clock Subsystem. If you need storage, consider using a standard cartridge save type or saving to a Controller Pak.</p>
<p >(As of July 2021) Joybus RTC does not work in combination with any EEPROM save type on EverDrive64 3.0 or X7. To have the best compatibility and player experience, it is not recommended to use the EEPROM + RTC ROM configuration. This is a bug in the EverDrive64 firmware and not a system limitation imposed by the Joybus protocol or Serial Interface.</p>
<p >Unfortunately, since only one game ever used Joybus RTC (and that game was later re-released on the GameCube in English), real-time clock support in emulators and flash carts can be incomplete, inaccurate, or non-existent. Many emulators do not actually implement the Joybus RTC write command and always respond with the host device's current local time. Some emulators and flash carts support writing to RTC but will not persist the date/time after resetting or powering-off. You can run the <code>rtctest</code> example ROM on your preferred emulator or flash cart to what RTC support is available.</p>
<p >The only reliable way to check if writes are actually supported is to write a time to the RTC and read the time back out. Many emulators that do support RTC reads will silently ignore RTC writes. You should detect whether writes are supported using <a class="el" href="group__rtc.html#gae5c739084610784801c6689fa99f0bd4" title="Determine whether the RTC supports writing the time.">rtc_is_writable</a> so that you can conditionally show the option to change the time if it's supported. If the RTC supports writes, it is safe to call <a class="el" href="group__rtc.html#ga49e1f7e05969bedd4b4e4789861c2944" title="High-level convenience helper to set the RTC date/time.">rtc_set</a> to set the date and time.</p>
<p >Due to the inaccurate and inconsistent behavior of RTC reproductions that currently exist, this subsystem trades-off complete accuracy with the actual Animal Forest RTC in favor of broader compatibility with the various quirks and bugs that exist in real-world scenarios like emulators and flash carts.</p>
<p >Some notable examples of RTC support in the ecosystem (as of July 2021):</p>
<p >64drive hw2 fully implements Joybus RTC including writes, but requires delays after setting the time (see <a class="el" href="group__rtc.html#ga0ea4d0bdff8d7f711477fb119aab0b6b" title="Duration (in milliseconds) to wait after setting Joybus RTC time.">JOYBUS_RTC_WRITE_FINISHED_DELAY</a>).</p>
<p >EverDrive64 3.0 and X7 partially support Joybus RTC, with caveats: The RTC must be explicitly enabled in the OS or with a ROM header configuration; RTC will not be detected if the EEPROM save type is used; RTC writes are not supported through the SI, so changing the time must be done in the OS.</p>
<p >UltraPIF fully implements an emulated Joybus RTC that can be accessed even when the cartridge does not include the real-time clock circuitry.</p>
<p >Special thanks to marshallh and jago85 for their hard work and research reverse-engineering and documenting the inner-workings of the Joybus RTC. </p>
<hr/><h2 class="groupheader">Data Structure Documentation</h2>
<a name="structrtc__time__t" id="structrtc__time__t"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structrtc__time__t">&#9670;&nbsp;</a></span>rtc_time_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct rtc_time_t</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p >Structure for storing RTC time data. </p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="a812da29fb4a23cf0e138f530283c7bb8" name="a812da29fb4a23cf0e138f530283c7bb8"></a>uint16_t</td>
<td class="fieldname">
year</td>
<td class="fielddoc">
Year. [1900-20XX]. </td></tr>
<tr><td class="fieldtype">
<a id="a72c1fb304848005b837a5966123feeb5" name="a72c1fb304848005b837a5966123feeb5"></a>uint8_t</td>
<td class="fieldname">
month</td>
<td class="fielddoc">
Month. [0-11]. </td></tr>
<tr><td class="fieldtype">
<a id="abcae6772be689db12a9a97451b9accb7" name="abcae6772be689db12a9a97451b9accb7"></a>uint8_t</td>
<td class="fieldname">
day</td>
<td class="fielddoc">
Day of month. [1-31]. </td></tr>
<tr><td class="fieldtype">
<a id="a1d50c8c929fc39c9c7d5addec7927a6f" name="a1d50c8c929fc39c9c7d5addec7927a6f"></a>uint8_t</td>
<td class="fieldname">
hour</td>
<td class="fielddoc">
Hours. [0-23]. </td></tr>
<tr><td class="fieldtype">
<a id="a521dfb37091082541a7a08d527b3e5c4" name="a521dfb37091082541a7a08d527b3e5c4"></a>uint8_t</td>
<td class="fieldname">
min</td>
<td class="fielddoc">
Minutes. [0-59]. </td></tr>
<tr><td class="fieldtype">
<a id="a9e6b7c9a15685fe8c90a969550b80e76" name="a9e6b7c9a15685fe8c90a969550b80e76"></a>uint8_t</td>
<td class="fieldname">
sec</td>
<td class="fielddoc">
Seconds. [0-59]. </td></tr>
<tr><td class="fieldtype">
<a id="a114773185cd5db69d5d6ee38800f63f1" name="a114773185cd5db69d5d6ee38800f63f1"></a>uint8_t</td>
<td class="fieldname">
week_day</td>
<td class="fielddoc">
Day of week. [0-6] (Sun-Sat) </td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="ga0dc5d7e2affd2f2156180e815dd14ad4" name="ga0dc5d7e2affd2f2156180e815dd14ad4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga0dc5d7e2affd2f2156180e815dd14ad4">&#9670;&nbsp;</a></span>JOYBUS_RTC_IDENTIFIER</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JOYBUS_RTC_IDENTIFIER&#160;&#160;&#160;0x1000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Joybus real-time clock identifier. </p>
<p >A magic value in the SI RTC status response that indicates the Joybus RTC is present. </p>

</div>
</div>
<a id="ga57d6e9d3af5cf6bd9fc9583b402f4057" name="ga57d6e9d3af5cf6bd9fc9583b402f4057"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga57d6e9d3af5cf6bd9fc9583b402f4057">&#9670;&nbsp;</a></span>JOYBUS_RTC_WRITE_BLOCK_DELAY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JOYBUS_RTC_WRITE_BLOCK_DELAY&#160;&#160;&#160;20</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Duration (in milliseconds) to wait after writing a Joybus RTC block. </p>
<p >The software should wait for the previous RTC write to finish before issuing another Joybus RTC command. Ideally, you could read the RTC status byte to determine when to proceed, but some RTC reproductions do not correctly implement the RTC status response, so a delay is used for compatibility. </p>

</div>
</div>
<a id="ga0ea4d0bdff8d7f711477fb119aab0b6b" name="ga0ea4d0bdff8d7f711477fb119aab0b6b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga0ea4d0bdff8d7f711477fb119aab0b6b">&#9670;&nbsp;</a></span>JOYBUS_RTC_WRITE_FINISHED_DELAY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JOYBUS_RTC_WRITE_FINISHED_DELAY&#160;&#160;&#160;500</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Duration (in milliseconds) to wait after setting Joybus RTC time. </p>
<p >64drive hw2 only updates the RTC readout a few times per second, so it is possible to write a new time, then read back the previous time before the 64drive clock ticks to update the "shadow interface" that the SI reads from.</p>
<p >Without this delay, the <a class="el" href="group__rtc.html#gae5c739084610784801c6689fa99f0bd4" title="Determine whether the RTC supports writing the time.">rtc_is_writable</a> test may fail intermittently on 64drive hw2. </p>

</div>
</div>
<a id="ga71dbc88287ffa0ab478324f96781d52b" name="ga71dbc88287ffa0ab478324f96781d52b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga71dbc88287ffa0ab478324f96781d52b">&#9670;&nbsp;</a></span>JOYBUS_RTC_STATUS_RUNNING</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JOYBUS_RTC_STATUS_RUNNING&#160;&#160;&#160;0x00</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The Joybus RTC is running. </p>
<p >It is safe to read the current time from the RTC. </p>

</div>
</div>
<a id="gaa78b824bcfec61517abb64c6aebd995b" name="gaa78b824bcfec61517abb64c6aebd995b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa78b824bcfec61517abb64c6aebd995b">&#9670;&nbsp;</a></span>JOYBUS_RTC_STATUS_STOPPED</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JOYBUS_RTC_STATUS_STOPPED&#160;&#160;&#160;0x80</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The Joybus RTC is stopped. </p>
<p >It is safe to write new time data to the RTC. </p>

</div>
</div>
<a id="ga0879c2dcd0a902265cccaa8f9a617800" name="ga0879c2dcd0a902265cccaa8f9a617800"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga0879c2dcd0a902265cccaa8f9a617800">&#9670;&nbsp;</a></span>JOYBUS_RTC_CONTROL_MODE_SET</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JOYBUS_RTC_CONTROL_MODE_SET&#160;&#160;&#160;0x0004</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Control mode for setting the Joybus RTC date/time. </p>
<p >Clears the write-protection bits and sets the stop bit. </p>

</div>
</div>
<a id="gad02da8fec42199c4c2d3ae5ab18e4395" name="gad02da8fec42199c4c2d3ae5ab18e4395"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gad02da8fec42199c4c2d3ae5ab18e4395">&#9670;&nbsp;</a></span>JOYBUS_RTC_CONTROL_MODE_RUN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define JOYBUS_RTC_CONTROL_MODE_RUN&#160;&#160;&#160;0x0300</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Control mode for normal operation of the Joybus RTC. </p>
<p >Clears the stop bit sets the write-protection bits.</p>
<p >0x0100 is the block 1 write-protection bit. 0x0200 is the block 2 write-protection bit. </p>

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="gaf4e6e809a36c78b63cd09260d3a5f561" name="gaf4e6e809a36c78b63cd09260d3a5f561"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf4e6e809a36c78b63cd09260d3a5f561">&#9670;&nbsp;</a></span>rtc_type_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="group__rtc.html#gaf4e6e809a36c78b63cd09260d3a5f561">rtc_type_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Real-time clock detection values. </p>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="ggaf4e6e809a36c78b63cd09260d3a5f561a9dab1cbcc7fe4e58711118114d5d01b9" name="ggaf4e6e809a36c78b63cd09260d3a5f561a9dab1cbcc7fe4e58711118114d5d01b9"></a>RTC_NONE&#160;</td><td class="fielddoc"><p >No RTC detected. </p>
</td></tr>
<tr><td class="fieldname"><a id="ggaf4e6e809a36c78b63cd09260d3a5f561a4d0e29dc302cd773d136d59377e7ce98" name="ggaf4e6e809a36c78b63cd09260d3a5f561a4d0e29dc302cd773d136d59377e7ce98"></a>RTC_JOYBUS&#160;</td><td class="fielddoc"><p >Joybus RTC detected. </p>
</td></tr>
<tr><td class="fieldname"><a id="ggaf4e6e809a36c78b63cd09260d3a5f561a6480131f6a48328e0aa3462411b23ee6" name="ggaf4e6e809a36c78b63cd09260d3a5f561a6480131f6a48328e0aa3462411b23ee6"></a>RTC_DD&#160;</td><td class="fielddoc"><p >N64 Disk Drive RTC detected. (Not implemented) </p>
</td></tr>
<tr><td class="fieldname"><a id="ggaf4e6e809a36c78b63cd09260d3a5f561a138cd0ae48518dc61b3ee47015709791" name="ggaf4e6e809a36c78b63cd09260d3a5f561a138cd0ae48518dc61b3ee47015709791"></a>RTC_UNKNOWN&#160;</td><td class="fielddoc"><p >RTC detection has not been occurred yet. </p>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga7d2152c20235fcc3520e5b1931e86405" name="ga7d2152c20235fcc3520e5b1931e86405"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga7d2152c20235fcc3520e5b1931e86405">&#9670;&nbsp;</a></span>rtc_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool rtc_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>High-level convenience helper to initialize the RTC subsystem. </p>
<p >The RTC Subsystem depends on the libdragon Timer Subsystem, so make sure to call <a class="el" href="group__timer.html#ga7b8ab79df77b57475a5494f5f81c3bd9" title="Initialize the timer subsystem.">timer_init</a> before calling <a class="el" href="group__rtc.html#ga7d2152c20235fcc3520e5b1931e86405" title="High-level convenience helper to initialize the RTC subsystem.">rtc_init</a>!</p>
<p >Some flash carts require the RTC to be explicitly enabled before loading the ROM file. Some emulators and flash carts do not support RTC at all.</p>
<p >This function will detect if the RTC is available and if so, will prepare the RTC so that the current time can be read from it.</p>
<p >This operation may take up to 50 milliseconds to complete.</p>
<p >This will also hook the RTC into the newlib gettimeofday function, so you will be able to use the ISO C time functions if RTC is available.</p>
<dl class="section return"><dt>Returns</dt><dd>whether the RTC is present and supported by the RTC Subsystem. </dd></dl>

</div>
</div>
<a id="gae6a9800f8788fe1d2232b36724e037aa" name="gae6a9800f8788fe1d2232b36724e037aa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae6a9800f8788fe1d2232b36724e037aa">&#9670;&nbsp;</a></span>rtc_close()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rtc_close </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Close the RTC Subsystem, disabling system hooks. </p>
<p >Unhooks the RTC from the newlib gettimeofday function. This will cause subsequent calls to gettimeofday to error with ENOSYS.</p>
<p >The only reason you should ever need to call this is if you need to stop the Timer Subsystem, which the RTC Subsystem depends on. If you do need to do this, make sure to call <a class="el" href="group__rtc.html#gae6a9800f8788fe1d2232b36724e037aa" title="Close the RTC Subsystem, disabling system hooks.">rtc_close</a> BEFORE <a class="el" href="group__timer.html#ga32c93080b7ed9264d7db8e5137a17c0d" title="Free and close the timer subsystem.">timer_close</a> and then call <a class="el" href="group__rtc.html#ga7d2152c20235fcc3520e5b1931e86405" title="High-level convenience helper to initialize the RTC subsystem.">rtc_init</a> again after you call <a class="el" href="group__timer.html#ga7b8ab79df77b57475a5494f5f81c3bd9" title="Initialize the timer subsystem.">timer_init</a> to restart the Timer Subsystem! </p>

</div>
</div>
<a id="gaac762f5c809e7e955b157446071dbaf3" name="gaac762f5c809e7e955b157446071dbaf3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaac762f5c809e7e955b157446071dbaf3">&#9670;&nbsp;</a></span>rtc_normalize_time()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rtc_normalize_time </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__rtc.html#structrtc__time__t">rtc_time_t</a> *&#160;</td>
          <td class="paramname"><em>rtc_time</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate sane values for arbitrary time inputs. </p>
<p >If your time inputs are already sane, nothing should change. This function will clamp date/time values within the expected ranges, including the correct day-of-month based on year/month. It will also recalculate the day-of-week based on the clamped year/month/day.</p>
<p >This is useful to call while the player is adjusting the time after each input to ensure that the date being set always makes sense before they actually confirm and commit the updated date/time. The rtctest example demonstrates a user-interface for setting the time with live validation.</p>
<p >Internally, RTC cannot represent dates before 1990-01-01, although some RTC implementations (like UltraPIF) only support dates after 2000-01-01.</p>
<p >For highest compatibility, it is not recommended to set the date past 2038-01-19 03:14:07 UTC, which is the UNIX timestamp Epochalypse.</p>
<p >Special thanks to networkfusion for providing the algorithm to calculate day-of-week from an arbitrary date.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">rtc_time</td><td>Pointer to the RTC time data structure </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="gaf9cee899189bcaef3244ed0643ee181a" name="gaf9cee899189bcaef3244ed0643ee181a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf9cee899189bcaef3244ed0643ee181a">&#9670;&nbsp;</a></span>rtc_get()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool rtc_get </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__rtc.html#structrtc__time__t">rtc_time_t</a> *&#160;</td>
          <td class="paramname"><em>rtc_time</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read the current date/time from the real-time clock. </p>
<p >If the RTC is not detected or supported, this function will not modify the destination rtc_time parameter.</p>
<p >Your code should call this once per frame to update the <a class="el" href="group__rtc.html#structrtc__time__t" title="Structure for storing RTC time data.">rtc_time_t</a> data structure. The RTC Subsystem maintains a cache of the most-recent RTC time that was read and will only perform an actual RTC read command if the cache is invalidated. The destination rtc_time parameter will be updated regardless of the cache validity.</p>
<p >Cache will invalidate every <a class="el" href="group__rtc.html#ga52141232434243f8a5442db59d3f4d17" title="Invalidate the most-recent RTC time cache after 1 second.">RTC_GET_CACHE_INVALIDATE_TICKS</a>. Calling <a class="el" href="group__rtc.html#ga49e1f7e05969bedd4b4e4789861c2944" title="High-level convenience helper to set the RTC date/time.">rtc_set</a> will also invalidate the cache.</p>
<p >If an actual RTC read command is needed, this function can take a few milliseconds to complete.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">rtc_time</td><td>Destination pointer for the RTC time data structure</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>whether the rtc_time destination pointer data was modified </dd></dl>

</div>
</div>
<a id="ga49e1f7e05969bedd4b4e4789861c2944" name="ga49e1f7e05969bedd4b4e4789861c2944"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga49e1f7e05969bedd4b4e4789861c2944">&#9670;&nbsp;</a></span>rtc_set()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool rtc_set </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__rtc.html#structrtc__time__t">rtc_time_t</a> *&#160;</td>
          <td class="paramname"><em>write_time</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>High-level convenience helper to set the RTC date/time. </p>
<p >Prepares the RTC for writing, sets the new time, and resumes the clock.</p>
<p >This function will take approximately 570 milliseconds to complete.</p>
<p >Unfortunately, the best way to ensure that writes to the RTC have actually finished is by waiting for a fixed duration. Emulators may not accurately reflect this, but this delay is necessary on real hardware.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">write_time</td><td>Source pointer for the RTC time data structure</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>false if the RTC does not support being set </dd></dl>

</div>
</div>
<a id="gae5c739084610784801c6689fa99f0bd4" name="gae5c739084610784801c6689fa99f0bd4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae5c739084610784801c6689fa99f0bd4">&#9670;&nbsp;</a></span>rtc_is_writable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool rtc_is_writable </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Determine whether the RTC supports writing the time. </p>
<p >Some emulators and flash carts do not support writing to the RTC, so this function makes an attempt to detect silent write failures and will return <code>false</code> if it is unable to change the time on the RTC.</p>
<p >This function is useful if your program wants to conditionally offer the ability to set the time based on hardware/emulator support.</p>
<p >Unfortunately this operation may introduce a slight drift in the clock, but it is the only way to determine if the RTC supports the write command.</p>
<p >This operation will take approximately 1 second to complete.</p>
<dl class="section return"><dt>Returns</dt><dd>whether RTC writes appear to be supported </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 10 2023 22:26:54 for libdragon by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
