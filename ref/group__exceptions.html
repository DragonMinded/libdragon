<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libdragon: Exception Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libdragon
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a> &#124;
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Exception Handler<div class="ingroups"><a class="el" href="group__libdragon.html">libdragon</a> &raquo; <a class="el" href="group__lowlevel.html">Low Level Hardware Interfaces</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Handle hardware-generated exceptions.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:exception_8c"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exception_8c.html">exception.c</a></td></tr>
<tr class="memdesc:exception_8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Exception Handler. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:exception_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="exception_8h.html">exception.h</a></td></tr>
<tr class="memdesc:exception_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Exception Handler. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:structreg__block__t"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#structreg__block__t">reg_block_t</a></td></tr>
<tr class="memdesc:structreg__block__t"><td class="mdescLeft">&#160;</td><td class="mdescRight">Structure representing a register block.  <a href="group__exceptions.html#structreg__block__t">More...</a><br /></td></tr>
<tr class="separator:structreg__block__t"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structexception__t"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#structexception__t">exception_t</a></td></tr>
<tr class="memdesc:structexception__t"><td class="mdescLeft">&#160;</td><td class="mdescRight">Structure representing an exception.  <a href="group__exceptions.html#structexception__t">More...</a><br /></td></tr>
<tr class="separator:structexception__t"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:ga16af7b253440dadd46a80a4b9fddba4d"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="group__exceptions.html#gga16af7b253440dadd46a80a4b9fddba4da90b2b2223067700d2015835a712151ba">EXCEPTION_TYPE_UNKNOWN</a> = 0
, <a class="el" href="group__exceptions.html#gga16af7b253440dadd46a80a4b9fddba4da8193732583ae3c307371a55998620919">EXCEPTION_TYPE_RESET</a>
, <a class="el" href="group__exceptions.html#gga16af7b253440dadd46a80a4b9fddba4da4512100e37620ac5e38279290ced9245">EXCEPTION_TYPE_CRITICAL</a>
 }</td></tr>
<tr class="memdesc:ga16af7b253440dadd46a80a4b9fddba4d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Exception types.  <a href="group__exceptions.html#ga16af7b253440dadd46a80a4b9fddba4d">More...</a><br /></td></tr>
<tr class="separator:ga16af7b253440dadd46a80a4b9fddba4d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga402ebff4d96f276dd02c0159707849a3"><td class="memItemLeft" align="right" valign="top"><a id="ga402ebff4d96f276dd02c0159707849a3"></a>enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#ga402ebff4d96f276dd02c0159707849a3">exception_code_t</a> { <br />
&#160;&#160;<b>EXCEPTION_CODE_INTERRUPT</b> = 0
, <b>EXCEPTION_CODE_TLB_MODIFICATION</b> = 1
, <b>EXCEPTION_CODE_TLB_LOAD_I_MISS</b> = 2
, <b>EXCEPTION_CODE_TLB_STORE_MISS</b> = 3
, <br />
&#160;&#160;<b>EXCEPTION_CODE_LOAD_I_ADDRESS_ERROR</b> = 4
, <b>EXCEPTION_CODE_STORE_ADDRESS_ERROR</b> = 5
, <b>EXCEPTION_CODE_I_BUS_ERROR</b> = 6
, <b>EXCEPTION_CODE_D_BUS_ERROR</b> = 7
, <br />
&#160;&#160;<b>EXCEPTION_CODE_SYS_CALL</b> = 8
, <b>EXCEPTION_CODE_BREAKPOINT</b> = 9
, <b>EXCEPTION_CODE_RESERVED_INSTRUCTION</b> = 10
, <b>EXCEPTION_CODE_COPROCESSOR_UNUSABLE</b> = 11
, <br />
&#160;&#160;<b>EXCEPTION_CODE_ARITHMETIC_OVERFLOW</b> = 12
, <b>EXCEPTION_CODE_TRAP</b> = 13
, <b>EXCEPTION_CODE_FLOATING_POINT</b> = 15
, <b>EXCEPTION_CODE_WATCH</b> = 23
<br />
 }</td></tr>
<tr class="memdesc:ga402ebff4d96f276dd02c0159707849a3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Exception codes. <br /></td></tr>
<tr class="separator:ga402ebff4d96f276dd02c0159707849a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga75b3553e5039dff6c46c8700e1100ffa"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#ga75b3553e5039dff6c46c8700e1100ffa">register_exception_handler</a> (void(*cb)(<a class="el" href="group__exceptions.html#structexception__t">exception_t</a> *))</td></tr>
<tr class="memdesc:ga75b3553e5039dff6c46c8700e1100ffa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Register an exception handler to handle exceptions.  <a href="group__exceptions.html#ga75b3553e5039dff6c46c8700e1100ffa">More...</a><br /></td></tr>
<tr class="separator:ga75b3553e5039dff6c46c8700e1100ffa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2ccc97f57a66f0091daa6529c4f52573"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#ga2ccc97f57a66f0091daa6529c4f52573">exception_default_handler</a> (<a class="el" href="group__exceptions.html#structexception__t">exception_t</a> *ex)</td></tr>
<tr class="memdesc:ga2ccc97f57a66f0091daa6529c4f52573"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default exception handler.  <a href="group__exceptions.html#ga2ccc97f57a66f0091daa6529c4f52573">More...</a><br /></td></tr>
<tr class="separator:ga2ccc97f57a66f0091daa6529c4f52573"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab07f39f1f4a7068b7b9347261f606829"><td class="memItemLeft" align="right" valign="top"><a id="gab07f39f1f4a7068b7b9347261f606829"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#gab07f39f1f4a7068b7b9347261f606829">__onCriticalException</a> ()</td></tr>
<tr class="memdesc:gab07f39f1f4a7068b7b9347261f606829"><td class="mdescLeft">&#160;</td><td class="mdescRight">Respond to a critical exception. <br /></td></tr>
<tr class="separator:gab07f39f1f4a7068b7b9347261f606829"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae07937d068ac4031dc36cce4187bcb4f"><td class="memItemLeft" align="right" valign="top"><a id="gae07937d068ac4031dc36cce4187bcb4f"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#gae07937d068ac4031dc36cce4187bcb4f">__onResetException</a> ()</td></tr>
<tr class="memdesc:gae07937d068ac4031dc36cce4187bcb4f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Respond to a reset exception. <br /></td></tr>
<tr class="separator:gae07937d068ac4031dc36cce4187bcb4f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:gada786eec0aadd1261e0298f192268467"><td class="memItemLeft" align="right" valign="top"><a id="gada786eec0aadd1261e0298f192268467"></a>
const void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__exceptions.html#gada786eec0aadd1261e0298f192268467">__baseRegAddr</a></td></tr>
<tr class="memdesc:gada786eec0aadd1261e0298f192268467"><td class="mdescLeft">&#160;</td><td class="mdescRight">Base register offset as defined by the interrupt controller. <br /></td></tr>
<tr class="separator:gada786eec0aadd1261e0298f192268467"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Handle hardware-generated exceptions. </p>
<p>The exception handler traps exceptions generated by hardware. This could be an invalid instruction or invalid memory access exception or it could be a reset exception. In both cases, a handler registered with <a class="el" href="group__exceptions.html#ga75b3553e5039dff6c46c8700e1100ffa" title="Register an exception handler to handle exceptions.">register_exception_handler</a> will be passed information regarding the exception type and relevant registers. </p>
<hr/><h2 class="groupheader">Data Structure Documentation</h2>
<a name="structreg__block__t" id="structreg__block__t"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structreg__block__t">&#9670;&nbsp;</a></span>reg_block_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct reg_block_t</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>Structure representing a register block. </p>
<p>DO NOT modify the order unless editing inthandler.S </p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="a29167e78972fa51420662cbc9a006060"></a>volatile const uint32_t</td>
<td class="fieldname">
cr</td>
<td class="fielddoc">
CR. </td></tr>
<tr><td class="fieldtype">
<a id="a8994feeb123b7ae966187c2ed854ea31"></a>volatile uint32_t</td>
<td class="fieldname">
epc</td>
<td class="fielddoc">
represents EPC - COP0 register $14 <p>The coprocessor 0 (system control coprocessor - COP0) register $14 is the return from exception program counter. For asynchronous exceptions it points to the place to continue execution whereas for synchronous (caused by code) exceptions, point to the instruction causing the fault condition, which needs correction in the exception handler. This member is for reading/writing its value. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a24828318c71baa53ef564594857610d7"></a>volatile uint32_t</td>
<td class="fieldname">
fc31</td>
<td class="fielddoc">
FC31. </td></tr>
<tr><td class="fieldtype">
<a id="acdf873009f0ee9fd6d8ff31029fd51d8"></a>volatile uint64_t</td>
<td class="fieldname">
fpr[32]</td>
<td class="fielddoc">
Floating point registers 1-32. </td></tr>
<tr><td class="fieldtype">
<a id="ab243a637b97df97aefb898ec631592d6"></a>volatile uint64_t</td>
<td class="fieldname">
gpr[32]</td>
<td class="fielddoc">
General purpose registers 1-32. </td></tr>
<tr><td class="fieldtype">
<a id="ae92e93df499b169dcc8aeae522d087c8"></a>volatile uint64_t</td>
<td class="fieldname">
hi</td>
<td class="fielddoc">
HI. </td></tr>
<tr><td class="fieldtype">
<a id="ae5f1917f3d4ff0c9c805aa5286fe49f2"></a>volatile uint64_t</td>
<td class="fieldname">
lo</td>
<td class="fielddoc">
LO. </td></tr>
<tr><td class="fieldtype">
<a id="aa68324d2ccd01013da6c56099b06c23a"></a>volatile uint32_t</td>
<td class="fieldname">
sr</td>
<td class="fielddoc">
SR. </td></tr>
</table>

</div>
</div>
<a name="structexception__t" id="structexception__t"></a>
<h2 class="memtitle"><span class="permalink"><a href="#structexception__t">&#9670;&nbsp;</a></span>exception_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct exception_t</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>Structure representing an exception. </p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="af3b2efbaae64f0e33c6153227aebdaba"></a><a class="el" href="group__exceptions.html#ga402ebff4d96f276dd02c0159707849a3">exception_code_t</a></td>
<td class="fieldname">
code</td>
<td class="fielddoc">
Underlying exception code. </td></tr>
<tr><td class="fieldtype">
<a id="a05e27f4f7ffca11f72050238adf56e14"></a>const char *</td>
<td class="fieldname">
info</td>
<td class="fielddoc">
String information of exception. </td></tr>
<tr><td class="fieldtype">
<a id="ad6be5aa1171734c05081c504e36f55f4"></a>volatile <a class="el" href="group__exceptions.html#structreg__block__t">reg_block_t</a> *</td>
<td class="fieldname">
regs</td>
<td class="fielddoc">
Registers at point of exception. </td></tr>
<tr><td class="fieldtype">
<a id="afbad107df38f2e4963547dbcbe5c88ae"></a>int32_t</td>
<td class="fieldname">
type</td>
<td class="fielddoc">
Exception type. <dl class="section see"><dt>See also</dt><dd><a class="el" href="group__exceptions.html#gga16af7b253440dadd46a80a4b9fddba4da8193732583ae3c307371a55998620919" title="Reset exception.">EXCEPTION_TYPE_RESET</a>, <a class="el" href="group__exceptions.html#gga16af7b253440dadd46a80a4b9fddba4da4512100e37620ac5e38279290ced9245" title="Critical exception.">EXCEPTION_TYPE_CRITICAL</a> </dd></dl>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="ga16af7b253440dadd46a80a4b9fddba4d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga16af7b253440dadd46a80a4b9fddba4d">&#9670;&nbsp;</a></span>anonymous enum</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Exception types. </p>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="gga16af7b253440dadd46a80a4b9fddba4da90b2b2223067700d2015835a712151ba"></a>EXCEPTION_TYPE_UNKNOWN&#160;</td><td class="fielddoc"><p>Unknown exception. </p>
</td></tr>
<tr><td class="fieldname"><a id="gga16af7b253440dadd46a80a4b9fddba4da8193732583ae3c307371a55998620919"></a>EXCEPTION_TYPE_RESET&#160;</td><td class="fielddoc"><p>Reset exception. </p>
</td></tr>
<tr><td class="fieldname"><a id="gga16af7b253440dadd46a80a4b9fddba4da4512100e37620ac5e38279290ced9245"></a>EXCEPTION_TYPE_CRITICAL&#160;</td><td class="fielddoc"><p>Critical exception. </p>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga2ccc97f57a66f0091daa6529c4f52573"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga2ccc97f57a66f0091daa6529c4f52573">&#9670;&nbsp;</a></span>exception_default_handler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void exception_default_handler </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__exceptions.html#structexception__t">exception_t</a> *&#160;</td>
          <td class="paramname"><em>ex</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Default exception handler. </p>
<p>This handler is installed by default for all exceptions. It initializes the console and dump the exception state to the screen, including the value of all GPR/FPR registers. It then calls abort() to abort execution. </p>

</div>
</div>
<a id="ga75b3553e5039dff6c46c8700e1100ffa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga75b3553e5039dff6c46c8700e1100ffa">&#9670;&nbsp;</a></span>register_exception_handler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void register_exception_handler </td>
          <td>(</td>
          <td class="paramtype">void(*)(<a class="el" href="group__exceptions.html#structexception__t">exception_t</a> *)&#160;</td>
          <td class="paramname"><em>cb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Register an exception handler to handle exceptions. </p>
<p>The registered handle is responsible for clearing any bits that may cause a re-trigger of the same exception and updating the EPC. An important example is the cause bits (12-17) of FCR31 from cop1. To prevent re-triggering the exception they should be cleared by the handler.</p>
<p>To manipulate the registers, update the values in the <a class="el" href="group__exceptions.html#structexception__t" title="Structure representing an exception.">exception_t</a> struct. They will be restored to appropriate locations when returning from the handler. Setting them directly will not work as expected as they will get overwritten with the values pointed by the struct.</p>
<p>There is only one exception to this, cr (cause register) which is also modified by the int handler before the saved values are restored thus it is only possible to update it through C0_WRITE_CR macro if it is needed. This shouldn't be necessary though as they are already handled by the library.</p>
<p>k0 ($26), k1 ($27) are not saved/restored and will not be available in the handler. Theoretically we can exclude s0-s7 ($16-$23), and gp ($28) to gain some performance as they are already saved by GCC when necessary. The same is true for sp ($29) and ra ($31) but current interrupt handler manipulates them via allocating a new stack and doing a jal. Similarly floating point registers f21-f31 are callee-saved. In the future we may consider removing them from the save state for interrupts (but not for exceptions)</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cb</td><td>Callback function to call when exceptions happen </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 30 2021 14:25:45 for libdragon by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
